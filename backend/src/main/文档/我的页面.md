# 我的页面接口文档

接口基地址：`http://localhost:5000/api/profile`  
允许跨域来源：`http://localhost:5173`

---

## 1. 设置偏好

- **方法 & 路径**：`POST /preferences`
- **说明**：保存/更新用户的选房偏好数据，写入 `user_preferences` 表。
- **请求体参数**：
  | 字段 | 类型 | 必填 | 说明 |
  | ---- | ---- | ---- | ---- |
  | `userId` | Long | 是 | 用户 ID |
  | `preferenceData` | Object | 是 | JSON 对象，支持以下字段 |
- **可用偏好字段**（多余字段会被过滤）：  
  `price_range`、`area_range`、`locations`、`districts`、`city`、`house_types`、`bedroom_range`、`orientations`、`decorations`、`keywords`、`budget`
- **请求示例**：
```json
{
  "userId": 1,
  "preferenceData": {
    "price_range": {"min": 300, "max": 600},
    "main_districts": ["南山区", "福田区"],
    "house_types": ["apartment"]
  }
}
```
- **响应示例（201）**：
```json
{
  "message": "偏好设置成功",
  "userId": 1
}
```
- **错误响应**：400（缺少参数）、500（写入失败）

---

## 2. 房价预测

- **方法 & 路径**：`POST /price-predict`
- **说明**：根据城市和房源特征调用对应模型，返回预测单价（万元/㎡）。城市与模型文件夹映射如下：
  - 北京 → `beijng`
  - 上海 → `shanghai`
  - 天津 → `tianjin`
  - 石家庄 → `shijiazhuang`
- **请求体参数**：
  | 字段 | 类型 | 必填 | 说明 |
  | ---- | ---- | ---- | ---- |
  | `city` | String | 是 | 城市名称 |
  | `features` | Object | 是 | 模型特征对象，键需与 `model_config.json` 的 `feature_columns` 对应；缺失值由服务端使用均值填充 |
- **常用特征示例**（可按需扩展）：
  - `经度`、`纬度`
  - `到市中心距离_km`
  - `面积（m²）`
  - `室数`、`厅数`、`卫数`
  - `房龄`
  - `区域编码` / `area_encoded`
  - `朝向评分`
  - `小区面积_数值`、`小区户数_数值`
  - `容积率_数值`、`绿化率_数值`、`物业费_数值`
- **请求示例**：
```json
{
  "city": "北京",
  "features": {
    "经度": 116.4014,
    "纬度": 39.9263,
    "到市中心距离_km": 8.5,
    "面积（m²）": 90,
    "室数": 3,
    "厅数": 2,
    "卫数": 2,
    "房龄": 10,
    "朝向评分": 4,
    "area_encoded": 14
  }
}
```
- **响应示例（200）**：
```json
{
  "city": "北京",
  "features": { ... },
  "predictedPricePerSquareMeter": 5.83,
  "unit": "万元/㎡",
  "message": "预测成功"
}
```
- **错误说明**：
  - 400：缺少 `city` / `features`、暂不支持的城市
  - 404：对应城市模型或配置缺失
  - 500：Python 预测脚本执行失败

---

## 3. 历史记录

- **方法 & 路径**：`GET /history`
- **说明**：根据 `userId` 查询 `browsing_history` 表，并关联 `properties`，返回用户浏览过的房源记录。
- **请求参数**：
  | 参数 | 类型 | 必填 | 说明 |
  | ---- | ---- | ---- | ---- |
  | `userId` | Long | 是 | 用户 ID |
- **请求示例**：`GET /api/profile/history?userId=1`
- **响应示例**：
```json
{
  "items": [
    {
      "historyId": 12,
      "propertyId": 101,
      "title": "万科城市花园 精装三房 南向采光好",
      "behaviorData": {"duration": 36, "device": "mobile"},
      "priceInfo": {"total_price": 650.5, "unit_price": 85000},
      "layoutInfo": {"bedroom_count": 3, "area": 89.5},
      "createdAt": "2025-03-03T10:20:30"
    }
  ],
  "count": 1,
  "message": "历史记录获取成功"
}
```
- **错误响应**：500（SQL/连接异常）

---

## 4. 收藏列表

- **方法 & 路径**：`GET /favorites`
- **说明**：返回用户收藏的全部房源，数据来源 `favorites` 表 + `properties` 表。
- **请求参数**：
  | 参数 | 类型 | 必填 | 说明 |
  | ---- | ---- | ---- | ---- |
  | `userId` | Long | 是 | 用户 ID |
- **请求示例**：`GET /api/profile/favorites?userId=1`
- **响应示例**：
```json
{
  "items": [
    {
      "favoriteId": 21,
      "propertyId": 105,
      "title": "深业上城 复式公寓",
      "priceInfo": {"total_price": 780.0, "unit_price": 90000},
      "layoutInfo": {"bedroom_count": 3, "area": 101},
      "createdAt": "2025-03-05T14:22:10"
    }
  ],
  "count": 1,
  "message": "收藏列表获取成功"
}
```
- **错误响应**：500（SQL异常）

---

## 数据库说明

- 数据脚本：`backend/script.sql`
- 主要表（与主页/查询页复用）：
  - `user_preferences`：存储用户偏好 JSON，供主页“我的”入口共享
  - `browsing_history`：用户浏览记录
  - `favorites`：用户收藏记录（查询页收藏接口也使用此表）
  - `properties`：房源基础信息（`price_info`、`layout_info` 等 JSON）
- 控制器通过 JDBC 直接访问上述表，连接配置来自 `application.properties`

---

## 调试建议

1. 确认数据库已按脚本创建并写入基础数据。
2. 偏好写入失败通常是 `userId` 不存在或字段不在白名单，可检查日志。
3. 历史/收藏接口依赖 `properties` 联查，确保外键完整。
4. 房价预测依赖 Python 环境与 pkl 模型，注意 `predictor.model-base-dir`、`predictor.python-exec` 配置。


