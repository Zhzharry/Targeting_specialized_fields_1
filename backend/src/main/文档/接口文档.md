# API 接口文档

## 概述

- **后端服务地址**：`http://localhost:5000`
- **允许跨域来源**：`http://localhost:5173`
- **数据库**：`second_hand_housing`（详见 `backend/script.sql`）
- **数据格式**：JSON

---

## 1. 登录模块 (`/api/login`)

### 1.1 用户登录

- **方法 & 路径**：`POST /api/login`
- **说明**：验证用户名与密码，返回用户信息
- **请求头**：`Content-Type: application/json`
- **请求体参数**：
  | 字段 | 类型 | 必填 | 说明 |
  | ---- | ---- | ---- | ---- |
  | `username` | String | 是 | 用户名 |
  | `password` | String | 是 | 密码（当前为明文） |
- **请求示例**：
```json
{
  "username": "demo_user",
  "password": "123456"
}
```
- **响应示例（200 成功）**：
```json
{
  "userId": 1,
  "username": "demo_user",
  "userProfile": "{\"budget\":{\"min\":300}}",
  "message": "登录成功"
}
```
- **错误响应**：
  - 400：`{"message": "用户名和密码不能为空"}`
  - 401：`{"message": "用户不存在"}` 或 `{"message": "用户名或密码错误"}`
  - 500：`{"message": "登录失败", "error": "数据库错误信息"}`

---

### 1.2 用户注册

- **方法 & 路径**：`POST /api/login/register`
- **说明**：创建新用户账户
- **请求头**：`Content-Type: application/json`
- **请求体参数**：
  | 字段 | 类型 | 必填 | 说明 |
  | ---- | ---- | ---- | ---- |
  | `username` | String | 是 | 用户名（唯一） |
  | `password` | String | 是 | 密码 |
  | `phone_number` | String | 是 | 手机号（唯一） |
  | `user_profile` | Object | 否 | 用户资料 JSON 对象 |
- **请求示例**：
```json
{
  "username": "new_user",
  "password": "123456",
  "phone_number": "13800138001",
  "user_profile": {
    "budget": {"min": 300, "max": 600},
    "preferred_locations": ["南山区", "福田区"]
  }
}
```
- **响应示例（201 成功）**：
```json
{
  "userId": 2,
  "username": "new_user",
  "message": "注册成功"
}
```
- **错误响应**：
  - 400：`{"message": "用户名和密码不能为空"}` 或 `{"message": "手机号不能为空"}`
  - 409：`{"message": "用户名已存在"}` 或 `{"message": "手机号已被注册"}`
  - 500：`{"message": "注册失败", "error": "数据库错误信息"}`

---

## 2. 主页模块 (`/api/home`)

### 2.1 首页概览

- **方法 & 路径**：`GET /api/home/overview`
- **说明**：返回首页顶部的全局概览信息（静态示例数据）
- **请求参数**：无
- **响应示例（200）**：
```json
{
  "title": "首页概览",
  "welcomeMessage": "欢迎访问首页",
  "notifications": 2,
  "shortcuts": ["我的", "猜你喜欢", "数据分析"]
}
```

---

### 2.2 我的页面信息

- **方法 & 路径**：`GET /api/home/me`
- **说明**：根据 `userId` 返回用户详情，供跳转"我的"页面使用。数据来源：`users` 与 `user_preferences` 表
- **请求参数**：
  | 参数 | 类型 | 必填 | 说明 |
  | ---- | ---- | ---- | ---- |
  | `userId` | Long | 是 | 用户 ID |
- **请求示例**：`GET /api/home/me?userId=1`
- **响应示例（200）**：
```json
{
  "profile": {
    "userId": 1,
    "username": "demo_user",
    "joinedAt": "2025-01-05T10:11:12Z",
    "userProfile": {
      "budget": {"min": 300, "max": 600},
      "preferred_locations": ["南山区", "福田区"]
    },
    "preferences": {
      "house_types": ["apartment"],
      "orientations": ["south"]
    },
    "stats": {
      "favorites": 12,
      "browsed": 48,
      "recommendations": 6
    }
  },
  "message": "个人信息获取成功"
}
```
- **错误响应**：
  - 404：用户不存在
  - 500：`{"message": "获取个人信息失败", "error": "错误信息"}`

---

### 2.3 猜你喜欢列表

- **方法 & 路径**：`GET /api/home/guess-you-like`
- **说明**：返回"猜你喜欢"模块的房源推荐（当前返回静态示例数据）
- **请求参数**：无
- **响应示例（200）**：
```json
{
  "items": [
    {
      "propertyId": 101,
      "title": "万科城市花园 精装三房 南向采光好",
      "summary": "南山区 · 89.5㎡ · 3室2厅2卫",
      "totalPrice": 650.5,
      "cover": "https://picsum.photos/seed/101/300/200",
      "detailUrl": "https://example.com/property/101",
      "tags": ["近地铁", "学区房", "南北通透"]
    }
  ],
  "message": "猜你喜欢数据（示例）"
}
```

---

### 2.4 查询页入口推荐

- **方法 & 路径**：`GET /api/home/go-query`
- **说明**：跳转到查询页前的入口接口，复用"猜你喜欢"数据，便于前端在查询页展示推荐卡片或做预加载
- **请求参数**：无
- **响应示例（200）**：
```json
{
  "items": [
    {
      "propertyId": 101,
      "title": "万科城市花园 精装三房 南向采光好",
      "summary": "南山区 · 89.5㎡ · 3室2厅2卫",
      "totalPrice": 650.5,
      "cover": "https://picsum.photos/seed/101/300/200",
      "detailUrl": "https://example.com/property/101",
      "tags": ["近地铁", "学区房", "南北通透"]
    }
  ],
  "message": "查询页推荐数据（示例）"
}
```

---

## 3. 查询模块 (`/api/query`)

### 3.1 房源查询

- **方法 & 路径**：`GET /api/query`
- **说明**：根据关键字与多种筛选条件，查询 `second_hand_housing` 数据库中的 `properties` 与 `communities` 表，返回房源列表
- **请求参数**：
  | 参数 | 类型 | 必填 | 说明 |
  | ---- | ---- | ---- | ---- |
  | `keyword` | String | 否 | 标题或小区名称模糊匹配 |
  | `district` | String | 否 | 行政区（`communities.location_info.district`） |
  | `minPrice` / `maxPrice` | Double | 否 | 总价范围（万元，`price_info.total_price`） |
  | `propertyType` | String | 否 | 房源类型（`basic_info.property_type`，如 `apartment`） |
  | `orientation` | String | 否 | 朝向（`layout_info.orientation`） |
  | `status` | String | 否 | 房源状态（`for_sale`/`sold`） |
  | `minBedrooms` / `maxBedrooms` | Integer | 否 | 户型卧室数范围（`layout_info.bedroom_count`） |
  | `minArea` / `maxArea` | Double | 否 | 面积范围（㎡，`layout_info.area`） |
  | `minViewCount` / `maxViewCount` | Integer | 否 | 浏览次数范围 |
- **请求示例**：  
  `GET /api/query?keyword=万科&district=南山区&propertyType=apartment&minBedrooms=3&maxPrice=800`
- **响应示例（200）**：
```json
{
  "items": [
    {
      "propertyId": 101,
      "title": "万科城市花园 精装三房 南向采光好",
      "status": "for_sale",
      "communityName": "万科城市花园",
      "viewCount": 35,
      "favoriteCount": 8,
      "updatedAt": "2025-03-01T12:34:56",
      "priceInfo": {
        "total_price": 650.5,
        "unit_price": 85000
      },
      "layoutInfo": {
        "bedroom_count": 3,
        "living_room_count": 2,
        "bathroom_count": 2,
        "area": 89.5
      },
      "basicInfo": {
        "property_type": "apartment",
        "build_year": 2018
      },
      "locationInfo": {
        "province": "广东省",
        "city": "深圳市",
        "district": "南山区"
      }
    }
  ],
  "count": 1,
  "message": "查询成功"
}
```
- **错误响应**：
  - 500：`{"message": "查询失败", "error": "SQL 异常信息"}`

---

### 3.2 收藏房源

- **方法 & 路径**：`POST /api/query/favorite`
- **说明**：收藏指定房源，写入 `favorites` 表。如果已存在则更新收藏时间
- **请求参数**：
  | 参数 | 类型 | 必填 | 说明 |
  | ---- | ---- | ---- | ---- |
  | `userId` | Long | 是 | 用户 ID |
  | `propertyId` | Long | 是 | 房源 ID |
- **请求示例**：`POST /api/query/favorite?userId=1&propertyId=1`
- **响应示例（201）**：
```json
{
  "message": "收藏成功",
  "userId": 1,
  "propertyId": 101
}
```
- **错误响应**：
  - 404：`{"message": "用户不存在", "userId": 1}` 或 `{"message": "房源不存在", "propertyId": 101}`
  - 500：`{"message": "收藏失败", "error": "错误信息"}`

---

### 3.3 取消收藏房源

- **方法 & 路径**：`DELETE /api/query/favorite`
- **说明**：取消收藏指定房源，从 `favorites` 表中删除记录
- **请求参数**：
  | 参数 | 类型 | 必填 | 说明 |
  | ---- | ---- | ---- | ---- |
  | `userId` | Long | 是 | 用户 ID |
  | `propertyId` | Long | 是 | 房源 ID |
- **请求示例**：`DELETE /api/query/favorite?userId=1&propertyId=101`
- **响应示例（200）**：
```json
{
  "userId": 1,
  "propertyId": 101,
  "message": "取消收藏成功"
}
```
- **错误响应**：
  - 500：`{"message": "取消收藏失败", "error": "错误信息"}`

---

## 4. 我的页面模块 (`/api/profile`)

### 4.1 设置偏好

- **方法 & 路径**：`POST /api/profile/preferences`
- **说明**：保存/更新用户的选房偏好数据，写入 `user_preferences` 表
- **重要**：必须使用 **POST** 方法，不能使用 GET 方法
- **请求头**：`Content-Type: application/json`
- **请求体参数**：
  | 字段 | 类型 | 必填 | 说明 |
  | ---- | ---- | ---- | ---- |
  | `userId` | Long | 是 | 用户 ID |
  | `preferenceData` | Object | 是 | JSON 对象，支持以下字段 |
- **可用偏好字段**（多余字段会被过滤）：  
  `price_range`、`area_range`、`locations`、`districts`、`city`、`house_types`、`bedroom_range`、`orientations`、`decorations`、`keywords`、`budget`
- **请求示例**：
```json
{
  "userId": 1,
  "preferenceData": {
    "price_range": {"min": 300, "max": 600},
    "main_districts": ["南山区", "福田区"],
    "house_types": ["apartment"]
  }
}
```
- **响应示例（201）**：
```json
{
  "message": "偏好设置成功",
  "userId": 1
}
```
- **错误响应**：
  - 400：`{"message": "userId 和 preferenceData 不能为空"}`
  - 405：`{"timestamp": "...", "status": 405, "error": "Method Not Allowed", "path": "/api/profile/preferences"}` - 使用了错误的 HTTP 方法（必须使用 POST）
  - 500：`{"message": "保存偏好失败", "error": "错误信息"}`

---

### 4.2 房价预测

- **方法 & 路径**：`POST /api/profile/price-predict`
- **说明**：根据城市和房源特征调用对应模型，返回预测单价（万元/㎡）。城市与模型文件夹映射如下：
  - 北京 → `beijng`
  - 上海 → `shanghai`
  - 天津 → `tianjin`
  - 石家庄 → `shijiazhuang`
- **请求头**：`Content-Type: application/json`
- **请求体参数**：
  | 字段 | 类型 | 必填 | 说明 |
  | ---- | ---- | ---- | ---- |
  | `city` | String | 是 | 城市名称 |
  | `features` | Object | 是 | 模型特征对象，键需与 `model_config.json` 的 `feature_columns` 对应；缺失值由服务端使用均值填充 |
- **常用特征示例**（可按需扩展）：
  - `经度`、`纬度`
  - `到市中心距离_km`
  - `面积（m²）`
  - `室数`、`厅数`、`卫数`
  - `房龄`
  - `区域编码` / `area_encoded`
  - `朝向评分`
  - `小区面积_数值`、`小区户数_数值`
  - `容积率_数值`、`绿化率_数值`、`物业费_数值`
- **请求示例**：
```json
{
  "city": "北京",
  "features": {
    "经度": 116.4014,
    "纬度": 39.9263,
    "到市中心距离_km": 8.5,
    "面积（m²）": 90,
    "室数": 3,
    "厅数": 2,
    "卫数": 2,
    "房龄": 10,
    "朝向评分": 4,
    "area_encoded": 14
  }
}
```
- **响应示例（200）**：
```json
{
  "city": "北京",
  "features": { ... },
  "predictedPricePerSquareMeter": 5.83,
  "unit": "万元/㎡",
  "message": "预测成功"
}
```
- **错误说明**：
  - 400：缺少 `city` / `features`、暂不支持的城市
  - 404：对应城市模型或配置缺失
  - 500：Python 预测脚本执行失败

---

### 4.3 历史记录

- **方法 & 路径**：`GET /api/profile/history`
- **说明**：根据 `userId` 查询 `browsing_history` 表，并关联 `properties`，返回用户浏览过的房源记录（最多返回 50 条）
- **请求参数**：
  | 参数 | 类型 | 必填 | 说明 |
  | ---- | ---- | ---- | ---- |
  | `userId` | Long | 是 | 用户 ID |
- **请求示例**：`GET /api/profile/history?userId=1`
- **响应示例（200）**：
```json
{
  "items": [
    {
      "historyId": 12,
      "propertyId": 101,
      "title": "万科城市花园 精装三房 南向采光好",
      "behaviorData": {"duration": 36, "device": "mobile"},
      "priceInfo": {"total_price": 650.5, "unit_price": 85000},
      "layoutInfo": {"bedroom_count": 3, "area": 89.5},
      "createdAt": "2025-03-03T10:20:30"
    }
  ],
  "count": 1,
  "message": "历史记录获取成功"
}
```
- **错误响应**：
  - 400：`{"message": "userId 参数不能为空"}` - 缺少 userId 参数或参数格式错误
  - 500：`{"message": "获取历史记录失败", "error": "错误信息"}`

---

### 4.4 收藏列表

- **方法 & 路径**：`GET /api/profile/favorites`
- **说明**：返回用户收藏的全部房源，数据来源 `favorites` 表 + `properties` 表
- **请求参数**：
  | 参数 | 类型 | 必填 | 说明 |
  | ---- | ---- | ---- | ---- |
  | `userId` | Long | 是 | 用户 ID |
- **请求示例**：`GET /api/profile/favorites?userId=1`
- **响应示例（200）**：
```json
{
  "items": [
    {
      "favoriteId": 21,
      "propertyId": 105,
      "title": "深业上城 复式公寓",
      "priceInfo": {"total_price": 780.0, "unit_price": 90000},
      "layoutInfo": {"bedroom_count": 3, "area": 101},
      "createdAt": "2025-03-05T14:22:10"
    }
  ],
  "count": 1,
  "message": "收藏列表获取成功"
}
```
- **错误响应**：
  - 400：`{"message": "userId 参数不能为空"}` - 缺少 userId 参数或参数格式错误
  - 500：`{"message": "获取收藏列表失败", "error": "错误信息"}`

---

## 数据库说明

### 主要数据表

- **`users`**：用户基础信息
  - `user_id`：主键，自增
  - `username`：用户名（唯一）
  - `password`：密码（当前为明文存储，示例环境）
  - `user_profile`：用户资料 JSON
  - `created_at`：创建时间

- **`user_preferences`**：用户偏好设置
  - `preference_id`：主键，自增
  - `user_id`：用户 ID（外键）
  - `preference_data`：偏好数据 JSON

- **`properties`**：房源基础信息
  - `property_id`：主键，自增
  - `title`：房源标题
  - `status`：房源状态（`for_sale`/`sold`）
  - `price_info`：价格信息 JSON（`total_price`、`unit_price`）
  - `layout_info`：户型信息 JSON（`bedroom_count`、`area` 等）
  - `basic_info`：基础信息 JSON（`property_type`、`build_year` 等）
  - `view_count`：浏览次数
  - `favorite_count`：收藏次数
  - `community_id`：小区 ID（外键）
  - `updated_at`：更新时间

- **`communities`**：小区信息
  - `community_id`：主键，自增
  - `name`：小区名称
  - `location_info`：位置信息 JSON（`province`、`city`、`district`）

- **`browsing_history`**：浏览记录
  - `history_id`：主键，自增
  - `user_id`：用户 ID（外键）
  - `property_id`：房源 ID（外键）
  - `behavior_data`：行为数据 JSON
  - `created_at`：创建时间

- **`favorites`**：收藏记录
  - `favorite_id`：主键，自增
  - `user_id`：用户 ID（外键）
  - `property_id`：房源 ID（外键）
  - `favorite_data`：收藏数据 JSON
  - `created_at`：创建时间

### 数据库脚本

- 数据脚本位置：`backend/script.sql`
- 数据库连接配置：`backend/src/main/resources/application.properties`（`spring.datasource.*`）

---

## 调试建议

1. **数据库初始化**：确保 MySQL 已按 `script.sql` 创建并写入基础数据
2. **连接配置**：检查 `application.properties` 中的数据库连接参数
3. **跨域设置**：所有接口已配置允许 `http://localhost:5173` 跨域访问
4. **错误排查**：
   - 400 错误：检查请求参数是否完整、格式是否正确
   - 404 错误：检查资源是否存在（用户、模型文件等）
   - 500 错误：查看后端日志，确认 SQL 语句和数据库连接是否正常
5. **房价预测**：确保 Python 环境与 pkl 模型文件已正确配置，注意 `predictor.model-base-dir`、`predictor.python-exec` 配置
6. **偏好设置**：偏好写入失败通常是 `userId` 不存在或字段不在白名单，可检查日志
7. **历史/收藏接口**：依赖 `properties` 联查，确保外键完整

---

## 接口汇总

| 模块 | 方法 | 路径 | 说明 |
| ---- | ---- | ---- | ---- |
| 登录 | POST | `/api/login` | 用户登录 |
| 登录 | POST | `/api/login/register` | 用户注册 |
| 主页 | GET | `/api/home/overview` | 首页概览 |
| 主页 | GET | `/api/home/me` | 我的页面信息 |
| 主页 | GET | `/api/home/guess-you-like` | 猜你喜欢 |
| 主页 | GET | `/api/home/go-query` | 查询页入口推荐 |
| 查询 | GET | `/api/query` | 房源查询 |
| 查询 | POST | `/api/query/favorite` | 收藏房源 |
| 查询 | DELETE | `/api/query/favorite` | 取消收藏 |
| 我的 | POST | `/api/profile/preferences` | 设置偏好 |
| 我的 | POST | `/api/profile/price-predict` | 房价预测 |
| 我的 | GET | `/api/profile/history` | 历史记录 |
| 我的 | GET | `/api/profile/favorites` | 收藏列表 |

---

